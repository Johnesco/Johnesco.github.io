<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>todooo 038 - Typewriter</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Courier New', monospace;
  overflow: hidden;
  background: #1a1a1a;
  height: 100vh;
  display: flex;
  flex-direction: column;
}
#paper {
  flex: 65;
  background: #f5f0e8;
  position: relative;
  overflow: hidden;
  background-image:
    repeating-linear-gradient(transparent, transparent 23px, #e8e3db 23px, #e8e3db 24px),
    url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><filter id="noise"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="4" stitchTiles="stitch"/></filter><rect width="100" height="100" filter="url(%23noise)" opacity="0.03"/></svg>');
}
#paper-content {
  position: absolute;
  left: 60px;
  right: 60px;
  top: 0;
  padding: 40px 0;
  transition: transform 0.1s ease-out;
  line-height: 24px;
  color: #1a1a1a;
  text-shadow: 0 0 0.5px rgba(0,0,0,0.2);
}
.paper-line {
  min-height: 24px;
  white-space: pre;
  position: relative;
}
.cursor {
  display: inline-block;
  width: 2px;
  height: 18px;
  background: #1a1a1a;
  animation: blink 1s infinite;
  vertical-align: text-bottom;
  margin-left: 1px;
}
@keyframes blink {
  0%, 49% { opacity: 1; }
  50%, 100% { opacity: 0; }
}
.header-text {
  text-align: center;
  color: #666;
  margin-bottom: 12px;
}
.header-title {
  font-weight: bold;
  font-size: 18px;
  margin: 8px 0 4px 0;
  color: #333;
}
.header-underline {
  letter-spacing: 2px;
  color: #999;
}
.line-number {
  position: absolute;
  left: -40px;
  color: #d5d0c8;
  font-size: 11px;
}
.completed {
  position: relative;
}
.strike-through {
  position: absolute;
  left: 0;
  right: 0;
  top: 0;
  color: #444;
  pointer-events: none;
}
.void-text {
  color: #aa3333 !important;
  opacity: 0.7;
}
#typewriter {
  flex: 35;
  background: linear-gradient(180deg, #2a2a2a 0%, #222 100%);
  position: relative;
  box-shadow: 0 -10px 30px rgba(0,0,0,0.5);
  border-top: 3px solid #1a1a1a;
}
#key-hammer-area {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 40px;
  overflow: hidden;
}
.key-hammer {
  position: absolute;
  width: 3px;
  height: 60px;
  background: linear-gradient(180deg, #1a1a1a, #333);
  border-radius: 2px;
  bottom: -60px;
  transition: transform 0.05s ease-out;
}
.key-hammer.strike {
  animation: hammer-strike 0.1s ease-out;
}
@keyframes hammer-strike {
  0% { transform: translateY(0); }
  50% { transform: translateY(-50px); }
  100% { transform: translateY(0); }
}
.rivet {
  position: absolute;
  width: 8px;
  height: 8px;
  background: radial-gradient(circle, #444, #1a1a1a);
  border-radius: 50%;
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.2);
}
#bell {
  position: absolute;
  right: 80px;
  top: 60px;
  width: 20px;
  height: 20px;
  background: radial-gradient(circle, #d4af37, #aa8c2a);
  border-radius: 50%;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  transition: transform 0.1s;
}
#bell.ring {
  animation: bell-ring 0.2s ease-out;
}
@keyframes bell-ring {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.2); box-shadow: 0 0 10px rgba(212,175,55,0.8); }
}
#sound-toggle {
  position: absolute;
  right: 30px;
  top: 60px;
  width: 40px;
  height: 20px;
  background: #1a1a1a;
  border-radius: 10px;
  cursor: pointer;
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
}
#sound-lever {
  position: absolute;
  width: 16px;
  height: 16px;
  background: #666;
  border-radius: 50%;
  top: 2px;
  transition: left 0.2s;
  box-shadow: 0 1px 2px rgba(0,0,0,0.3);
}
#sound-toggle.on #sound-lever {
  left: 22px;
  background: #4a4;
}
#sound-toggle.off #sound-lever {
  left: 2px;
  background: #a44;
}
#carriage-indicator {
  position: absolute;
  top: -20px;
  left: 60px;
  width: 2px;
  height: 15px;
  background: #666;
  transition: transform 0.05s linear;
}
.paper-shake {
  animation: shake 0.03s ease-out;
}
@keyframes shake {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-0.5px); }
}
#platen {
  position: absolute;
  top: -20px;
  left: 0;
  right: 0;
  height: 20px;
  background: linear-gradient(90deg, #1a1a1a 0%, #333 50%, #1a1a1a 100%);
  border-top: 2px solid #0a0a0a;
}
.char-stamp {
  animation: stamp 0.05s ease-out;
}
@keyframes stamp {
  0% { font-weight: bold; transform: scale(1.1); }
  100% { font-weight: normal; transform: scale(1); }
}
</style>
</head>
<body>
<div id="paper">
  <div id="carriage-indicator"></div>
  <div id="paper-content"></div>
</div>
<div id="typewriter">
  <div id="platen"></div>
  <div id="key-hammer-area"></div>
  <div id="bell"></div>
  <div id="sound-toggle" class="on">
    <div id="sound-lever"></div>
  </div>
  <div class="rivet" style="left: 30px; top: 60px;"></div>
  <div class="rivet" style="right: 30px; top: 100px;"></div>
  <div class="rivet" style="left: 50%; top: 80px; transform: translateX(-50%);"></div>
</div>
<script>
const STORAGE_KEY = 'todooo-038';
let tasks = [];
let currentLine = 0;
let cursorCol = 0;
let soundEnabled = true;
let audioContext;
let currentText = '';

const paperContent = document.getElementById('paper-content');
const bell = document.getElementById('bell');
const soundToggle = document.getElementById('sound-toggle');
const carriageIndicator = document.getElementById('carriage-indicator');
const keyHammerArea = document.getElementById('key-hammer-area');

function initAudio() {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
}

function playSound(type) {
  if (!soundEnabled) return;
  initAudio();
  const now = audioContext.currentTime;

  if (type === 'clack') {
    const noise = audioContext.createBufferSource();
    const buffer = audioContext.createBuffer(1, 2048, audioContext.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < 2048; i++) data[i] = Math.random() * 2 - 1;
    noise.buffer = buffer;

    const filter = audioContext.createBiquadFilter();
    filter.type = 'bandpass';
    filter.frequency.value = 1200;
    filter.Q.value = 2;

    const gain = audioContext.createGain();
    gain.gain.setValueAtTime(0.08, now);
    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);

    noise.connect(filter).connect(gain).connect(audioContext.destination);
    noise.start(now);
    noise.stop(now + 0.05);
  } else if (type === 'space') {
    const noise = audioContext.createBufferSource();
    const buffer = audioContext.createBuffer(1, 2400, audioContext.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < 2400; i++) data[i] = Math.random() * 2 - 1;
    noise.buffer = buffer;

    const filter = audioContext.createBiquadFilter();
    filter.type = 'bandpass';
    filter.frequency.value = 600;
    filter.Q.value = 1.5;

    const gain = audioContext.createGain();
    gain.gain.setValueAtTime(0.1, now);
    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.06);

    noise.connect(filter).connect(gain).connect(audioContext.destination);
    noise.start(now);
    noise.stop(now + 0.06);
  } else if (type === 'ding') {
    const osc = audioContext.createOscillator();
    osc.frequency.value = 2000;
    const gain = audioContext.createGain();
    gain.gain.setValueAtTime(0.15, now);
    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
    osc.connect(gain).connect(audioContext.destination);
    osc.start(now);
    osc.stop(now + 0.2);
  } else if (type === 'return') {
    const noise = audioContext.createBufferSource();
    const buffer = audioContext.createBuffer(1, 4800, audioContext.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < 4800; i++) data[i] = Math.random() * 2 - 1;
    noise.buffer = buffer;

    const filter = audioContext.createBiquadFilter();
    filter.type = 'bandpass';
    filter.frequency.setValueAtTime(800, now);
    filter.frequency.linearRampToValueAtTime(400, now + 0.1);
    filter.Q.value = 2;

    const gain = audioContext.createGain();
    gain.gain.setValueAtTime(0.12, now);
    gain.gain.linearRampToValueAtTime(0.01, now + 0.1);

    noise.connect(filter).connect(gain).connect(audioContext.destination);
    noise.start(now);
    noise.stop(now + 0.1);
  } else if (type === 'backspace') {
    const noise = audioContext.createBufferSource();
    const buffer = audioContext.createBuffer(1, 1024, audioContext.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < 1024; i++) data[i] = Math.random() * 2 - 1;
    noise.buffer = buffer;

    const filter = audioContext.createBiquadFilter();
    filter.type = 'bandpass';
    filter.frequency.value = 900;
    filter.Q.value = 2;

    const gain = audioContext.createGain();
    gain.gain.setValueAtTime(0.05, now);
    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.03);

    noise.connect(filter).connect(gain).connect(audioContext.destination);
    noise.start(now);
    noise.stop(now + 0.03);
  }
}

function animateHammer(char) {
  const hammer = document.createElement('div');
  hammer.className = 'key-hammer strike';
  const charCode = char.charCodeAt(0);
  const offset = (charCode % 26) * 30 + 100;
  hammer.style.left = offset + 'px';
  keyHammerArea.appendChild(hammer);
  setTimeout(() => hammer.remove(), 100);
}

function updateCarriageIndicator() {
  carriageIndicator.style.transform = `translateX(${cursorCol * 7.2}px)`;
}

function init() {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved) {
    const data = JSON.parse(saved);
    tasks = data.tasks || [];
    currentLine = data.currentLine || 0;
    cursorCol = data.cursorCol || 0;
    currentText = data.currentText || '';
  }

  if (tasks.length === 0) {
    const today = new Date();
    const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    const dateStr = `${months[today.getMonth()]} ${today.getDate()}, ${today.getFullYear()}`;
    tasks.push({ type: 'header', text: dateStr });
    tasks.push({ type: 'header', text: 'THINGS TO DO' });
    tasks.push({ type: 'header', text: '─────────────────────────────────' });
    tasks.push({ type: 'blank' });
    currentLine = tasks.length;
  }

  render();
  updateCarriageIndicator();
}

function save() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify({
    tasks,
    currentLine,
    cursorCol,
    currentText
  }));
}

function render() {
  let html = '';
  tasks.forEach((task, i) => {
    if (task.type === 'header') {
      const centered = task.text.startsWith('THINGS TO DO');
      html += `<div class="paper-line ${centered ? 'header-title' : 'header-text'}">`;
      if (centered) {
        html += `<div class="header-title">${task.text}</div>`;
      } else if (task.text.includes('─')) {
        html += `<div class="header-underline">${task.text}</div>`;
      } else {
        html += task.text;
      }
      html += '</div>';
    } else if (task.type === 'blank') {
      html += '<div class="paper-line"></div>';
    } else if (task.type === 'void') {
      html += `<div class="paper-line void-text"><span class="line-number">${i}</span>${task.text}</div>`;
    } else {
      const checkbox = task.completed ? '[X]' : '[ ]';
      const cls = task.completed ? 'completed' : '';
      html += `<div class="paper-line ${cls}"><span class="line-number">${i}</span>${checkbox} ${task.text}`;
      if (task.completed && task.strikeText) {
        html += `<span class="strike-through">${task.strikeText}</span>`;
      }
      html += '</div>';
    }
  });

  html += `<div class="paper-line"><span class="line-number">${tasks.length}</span>${escapeHtml(currentText)}<span class="cursor"></span></div>`;

  paperContent.innerHTML = html;

  const scrollOffset = Math.max(0, (currentLine - 8) * 24);
  paperContent.style.transform = `translateY(-${scrollOffset}px)`;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function addChar(char) {
  if (cursorCol >= 75) {
    playSound('ding');
    bell.classList.add('ring');
    setTimeout(() => bell.classList.remove('ring'), 200);
  }

  currentText += char;
  cursorCol++;
  playSound(char === ' ' ? 'space' : 'clack');
  animateHammer(char);
  paperContent.classList.add('paper-shake');
  setTimeout(() => paperContent.classList.remove('paper-shake'), 30);
  render();
  updateCarriageIndicator();
  save();
}

function handleEnter() {
  if (currentText.trim()) {
    tasks.push({ type: 'task', text: currentText.trim(), completed: false });
  } else {
    tasks.push({ type: 'blank' });
  }
  currentText = '';
  cursorCol = 0;
  currentLine = tasks.length;
  playSound('return');
  playSound('ding');
  render();
  updateCarriageIndicator();
  save();
}

function handleBackspace() {
  if (currentText.length > 0) {
    currentText = currentText.slice(0, -1);
    cursorCol = Math.max(0, cursorCol - 1);
    playSound('backspace');
    render();
    updateCarriageIndicator();
    save();
  }
}

function handleTab() {
  for (let i = currentLine; i < tasks.length; i++) {
    if (tasks[i].type === 'task') {
      currentLine = i;
      currentText = '';
      cursorCol = 0;
      render();
      updateCarriageIndicator();
      save();
      return;
    }
  }
  for (let i = 0; i < currentLine; i++) {
    if (tasks[i].type === 'task') {
      currentLine = i;
      currentText = '';
      cursorCol = 0;
      render();
      updateCarriageIndicator();
      save();
      return;
    }
  }
}

function toggleTask() {
  if (currentLine < tasks.length && tasks[currentLine].type === 'task') {
    const task = tasks[currentLine];
    task.completed = !task.completed;

    if (task.completed) {
      let strikeText = '    ';
      for (let i = 0; i < task.text.length; i++) {
        strikeText += 'X';
      }
      task.strikeText = strikeText;

      let delay = 0;
      for (let i = 0; i < task.text.length; i++) {
        setTimeout(() => {
          playSound('clack');
          render();
        }, delay);
        delay += 20;
      }
    } else {
      task.strikeText = '';
    }

    render();
    save();
  }
}

function handleDelete() {
  if (currentLine < tasks.length && tasks[currentLine].type === 'task') {
    tasks[currentLine] = { type: 'void', text: 'VOID' };
    setTimeout(() => {
      tasks.splice(currentLine, 1);
      if (currentLine >= tasks.length) currentLine = tasks.length - 1;
      render();
      save();
    }, 500);
    render();
    save();
  }
}

function handleArrowUp() {
  if (currentLine > 0) {
    currentLine--;
    currentText = '';
    cursorCol = 0;
    render();
    updateCarriageIndicator();
    save();
  }
}

function handleArrowDown() {
  if (currentLine < tasks.length - 1) {
    currentLine++;
    currentText = '';
    cursorCol = 0;
    render();
    updateCarriageIndicator();
    save();
  }
}

function handleHome() {
  currentLine = 0;
  currentText = '';
  cursorCol = 0;
  render();
  updateCarriageIndicator();
  save();
}

function newPage() {
  tasks = [];
  const today = new Date();
  const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  const dateStr = `${months[today.getMonth()]} ${today.getDate()}, ${today.getFullYear()}`;
  tasks.push({ type: 'header', text: dateStr });
  tasks.push({ type: 'header', text: 'THINGS TO DO' });
  tasks.push({ type: 'header', text: '─────────────────────────────────' });
  tasks.push({ type: 'blank' });
  currentLine = tasks.length;
  currentText = '';
  cursorCol = 0;

  paperContent.style.transform = 'translateY(-2000px)';
  setTimeout(() => {
    render();
    updateCarriageIndicator();
    save();
  }, 300);
}

document.addEventListener('keydown', (e) => {
  if (e.ctrlKey && e.key === 'n') {
    e.preventDefault();
    newPage();
    return;
  }

  if (e.key === 'Enter') {
    e.preventDefault();
    handleEnter();
  } else if (e.key === 'Backspace') {
    e.preventDefault();
    handleBackspace();
  } else if (e.key === 'Tab') {
    e.preventDefault();
    handleTab();
  } else if (e.key === 'x' || e.key === 'X') {
    if (currentText === '' && currentLine < tasks.length && tasks[currentLine].type === 'task') {
      e.preventDefault();
      toggleTask();
    } else if (e.key.length === 1 && !e.ctrlKey && !e.altKey && !e.metaKey) {
      e.preventDefault();
      addChar(e.key);
    }
  } else if (e.key === 'Delete') {
    e.preventDefault();
    handleDelete();
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    handleArrowUp();
  } else if (e.key === 'ArrowDown') {
    e.preventDefault();
    handleArrowDown();
  } else if (e.key === 'Home') {
    e.preventDefault();
    handleHome();
  } else if (e.key.length === 1 && !e.ctrlKey && !e.altKey && !e.metaKey) {
    e.preventDefault();
    addChar(e.key);
  }
});

soundToggle.addEventListener('click', () => {
  soundEnabled = !soundEnabled;
  soundToggle.className = soundEnabled ? 'on' : 'off';
});

init();
</script>
</body>
</html>
