<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Dracula's Castle &mdash; A Text Adventure</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html {
  height: 100%;
  background: #0a0408;
  color: #c8b8a0;
  font-family: Georgia, "Times New Roman", serif;
}

body {
  min-height: 100%;
  display: flex;
  flex-direction: column;
}

/* --- Landing Page --- */
.landing {
  max-width: 780px;
  margin: 0 auto;
  padding: 60px 24px 80px;
  line-height: 1.7;
}

.landing h1 {
  font-size: 2em;
  color: #e0c8a0;
  letter-spacing: 2px;
  margin-bottom: 4px;
}

.landing .subtitle {
  font-style: italic;
  color: #8a6040;
  margin-bottom: 36px;
  font-size: 1.05em;
}

.landing p {
  margin-bottom: 16px;
  color: #a09080;
}

.landing h2 {
  font-size: 1.2em;
  color: #c0a880;
  margin-top: 44px;
  margin-bottom: 16px;
  padding-bottom: 6px;
  border-bottom: 1px solid #201810;
}

a {
  color: #d4a060;
  text-decoration: none;
  border-bottom: 1px solid #4a3020;
  transition: color 0.15s, border-color 0.15s;
}

a:hover {
  color: #f0c878;
  border-bottom-color: #8a6040;
}

/* --- Buttons --- */
.btn-row {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin: 24px 0;
}

.btn {
  display: inline-block;
  padding: 14px 28px;
  background: #1a100a;
  border: 1px solid #3a2018;
  border-radius: 6px;
  color: #d4a060;
  font-family: inherit;
  font-size: 1.05em;
  letter-spacing: 0.5px;
  cursor: pointer;
  transition: background 0.15s, border-color 0.15s, color 0.15s;
  text-align: center;
}

.btn:hover {
  background: #2a1810;
  border-color: #6a4030;
  color: #f0c878;
  border-bottom: 1px solid #6a4030;
}

.btn.active {
  background: #2a1810;
  border-color: #8a5030;
  color: #f0c878;
}

.btn-play {
  background: #200808;
  border-color: #5a1818;
  color: #d06040;
}

.btn-play:hover {
  background: #301010;
  border-color: #7a2828;
  color: #f08060;
  border-bottom: 1px solid #7a2828;
}

/* --- Tab system --- */
.tab-bar {
  display: flex;
  gap: 2px;
  background: #0e0808;
  border-bottom: 1px solid #201810;
  padding: 0 8px;
}

.tab-btn {
  padding: 10px 24px;
  background: transparent;
  border: none;
  border-bottom: 2px solid transparent;
  color: #806050;
  font-family: inherit;
  font-size: 0.9em;
  cursor: pointer;
  transition: color 0.15s, border-color 0.15s;
}

.tab-btn:hover {
  color: #c0a080;
}

.tab-btn.active {
  color: #e0c8a0;
  border-bottom-color: #d4a060;
}

.tab-content {
  display: none;
  height: 100vh;
  max-height: 100vh;
  overflow: hidden;
}

.tab-content.active {
  display: flex;
  flex-direction: column;
}

.tab-content > * {
  min-height: 0;
}

/* --- Source viewer --- */
.source-view {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-height: 0;
}

.source-toolbar {
  padding: 8px 20px;
  background: #0e0808;
  border-bottom: 1px solid #201810;
  display: flex;
  align-items: center;
  gap: 16px;
  font-size: 0.85em;
  color: #806050;
}

.source-toolbar .file-path {
  font-family: "SF Mono", "Fira Code", Consolas, "Courier New", monospace;
  font-size: 0.9em;
  color: #a08060;
}

.source-toolbar .line-count {
  margin-left: auto;
}

.search-box {
  background: #110808;
  border: 1px solid #2a1810;
  border-radius: 4px;
  color: #c8b8a0;
  font-family: "SF Mono", "Fira Code", Consolas, "Courier New", monospace;
  font-size: 0.9em;
  padding: 3px 8px;
  width: 200px;
  outline: none;
}

.search-box:focus { border-color: #5a3020; }
.search-box::placeholder { color: #4a3020; }

.code-wrap {
  flex: 1;
  overflow: auto;
  padding: 16px 0;
  min-height: 0;
}

.code-wrap::-webkit-scrollbar { width: 8px; }
.code-wrap::-webkit-scrollbar-track { background: #0a0408; }
.code-wrap::-webkit-scrollbar-thumb { background: #2a1810; border-radius: 4px; }
.code-wrap::-webkit-scrollbar-thumb:hover { background: #3a2818; }

/* --- Code table --- */
table.code {
  border-collapse: collapse;
  width: 100%;
  font-family: "SF Mono", "Fira Code", "Cascadia Code", Consolas, "Courier New", monospace;
  font-size: 14px;
  line-height: 1.55;
}

table.code td { vertical-align: top; }

td.ln {
  min-width: 52px;
  padding: 0 16px 0 20px;
  text-align: right;
  color: #302018;
  user-select: none;
  white-space: nowrap;
}

td.lc {
  white-space: pre-wrap;
  word-break: break-all;
  padding: 0 20px 0 0;
}

/* BASIC has no line-number column, so add left padding */
#code-basic td.lc {
  padding-left: 20px;
}

tr.heading-line td { padding-top: 8px; }
tr.heading-line td.lc { font-weight: bold; color: #e0c8a0; font-size: 15px; }
tr.heading-line td.ln { color: #5a4030; }

tr:target td, tr.highlight td { background: #1a1008; }
tr:target td.ln, tr.highlight td.ln { color: #806050; }

/* --- BASIC syntax colors --- */
.bas-kw   { color: #c08050; font-weight: bold; }
.bas-str  { color: #8bab6e; }
.bas-num  { color: #b08a70; }
.bas-rem  { color: #605840; font-style: italic; }
.bas-ln   { color: #7a6050; }
.bas-func { color: #7ea8b0; }
.bas-op   { color: #b89860; }

/* --- BASIC annotation blocks --- */
tr.bas-annotation td.lc {
  font-family: Georgia, "Times New Roman", serif;
  font-size: 13px;
  color: #7a9a6a;
  line-height: 1.45;
  padding: 1px 20px 1px 24px;
  border-left: 2px solid #2a4a20;
  white-space: pre-wrap;
}

tr.bas-annotation + tr:not(.bas-annotation) td.lc { padding-top: 6px; }
tr:not(.bas-annotation) + tr.bas-annotation td.lc { padding-top: 6px; }

/* separator lines (@@  === or @@ ---) rendered as thin rules */
tr.bas-annotation.anno-rule td.lc {
  padding-top: 10px;
  padding-bottom: 2px;
  border-left-color: transparent;
  color: #3a5a30;
}

/* --- Toggle button in toolbar --- */
.toggle-btn {
  padding: 4px 14px;
  background: #1a100a;
  border: 1px solid #3a2018;
  border-radius: 4px;
  color: #a08060;
  font-family: inherit;
  font-size: 0.85em;
  cursor: pointer;
  transition: background 0.15s, border-color 0.15s, color 0.15s;
  white-space: nowrap;
}
.toggle-btn:hover {
  background: #2a1810;
  border-color: #6a4030;
  color: #d4a060;
}
.toggle-btn.active {
  background: #1a2a10;
  border-color: #4a6a30;
  color: #8bab6e;
}

/* --- Inform 7 syntax colors --- */
.syn-str  { color: #8bab6e; }
.syn-cmt  { color: #605840; font-style: italic; }
.syn-sub  { color: #7ea8b0; }
.syn-kw   { color: #c08050; }
.syn-head { color: #e0c8a0; font-weight: bold; }
.syn-rule { color: #b89860; }
.syn-num  { color: #b08a70; }
.syn-tbl  { color: #9090b0; }

/* --- Play area --- */
.play-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 500px;
  padding: 40px 24px;
  background: #080404;
}

.play-area iframe {
  width: 100%;
  max-width: 900px;
  height: 80vh;
  border: 1px solid #2a1810;
  border-radius: 4px;
  background: #000;
}

.play-placeholder {
  text-align: center;
  color: #806050;
  max-width: 560px;
}

.play-placeholder h3 {
  color: #c0a880;
  margin-bottom: 16px;
  font-size: 1.2em;
}

.play-placeholder p {
  margin-bottom: 12px;
  line-height: 1.6;
}

.play-placeholder code {
  background: #1a100a;
  padding: 2px 8px;
  border-radius: 3px;
  font-size: 0.9em;
  color: #d4a060;
}

.play-placeholder .file-drop {
  margin: 24px auto;
  padding: 40px;
  border: 2px dashed #3a2018;
  border-radius: 8px;
  color: #604838;
  transition: border-color 0.15s, color 0.15s;
  cursor: pointer;
}

.play-placeholder .file-drop:hover,
.play-placeholder .file-drop.drag-over {
  border-color: #7a4030;
  color: #a08060;
}

.play-placeholder .file-drop input {
  display: none;
}

/* --- Search highlights --- */
.search-hit {
  background: #4a3010;
  color: #ffe0a0;
  border-radius: 2px;
}

.search-current {
  background: #6a4a10;
  outline: 1px solid #aa8030;
}

/* --- Loading / error --- */
.loading {
  text-align: center;
  padding: 80px 40px;
  color: #806050;
  font-size: 1.1em;
}

.loading em {
  animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 0.4; }
  50% { opacity: 1; }
}

.error-msg {
  text-align: center;
  padding: 80px 40px;
  color: #a06040;
}

/* --- Nav sidebar --- */
.sidebar {
  width: 260px;
  min-width: 260px;
  background: #0c0606;
  border-right: 1px solid #201810;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.nav {
  flex: 1;
  overflow-y: auto;
  padding: 8px 0;
}

.nav::-webkit-scrollbar { width: 6px; }
.nav::-webkit-scrollbar-track { background: #0c0606; }
.nav::-webkit-scrollbar-thumb { background: #2a1810; border-radius: 3px; }

.nav-item {
  display: block;
  padding: 4px 16px;
  font-size: 0.82em;
  color: #886850;
  text-decoration: none;
  cursor: pointer;
  border-left: 2px solid transparent;
  border-bottom: none;
  transition: background 0.1s, color 0.1s;
}

.nav-item:hover {
  background: #151008;
  color: #c0a080;
  border-bottom: none;
}

.nav-item.active {
  background: #18100a;
  color: #e0c8a0;
  border-left-color: #d4a060;
  border-bottom: none;
}

.nav-part {
  font-weight: bold;
  color: #c0a080;
  padding-top: 10px;
  font-size: 0.85em;
}

.nav-chapter { padding-left: 24px; }
.nav-section { padding-left: 36px; font-size: 0.78em; color: #705840; }

/* --- Source view with sidebar layout --- */
.source-with-nav {
  flex: 1;
  display: flex;
  overflow: hidden;
  min-height: 0;
}

.source-main {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  min-height: 0;
}

/* --- Credits box --- */
.credits-box {
  margin: 24px 0;
  padding: 24px 28px;
  background: #0e0808;
  border: 1px solid #1a1210;
  border-radius: 6px;
}

.credits-box h3 {
  color: #c0a880;
  font-size: 0.95em;
  margin-bottom: 10px;
  margin-top: 20px;
}

.credits-box h3:first-child {
  margin-top: 0;
}

.credits-box p {
  font-size: 0.95em;
  color: #a09080;
  margin-bottom: 10px;
  line-height: 1.65;
}

.links-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 6px 32px;
  font-size: 0.9em;
  margin-bottom: 8px;
}

.links-grid a {
  color: #a08060;
  border-bottom-color: #201810;
}

.links-grid a:hover {
  color: #d4a060;
}

/* --- Puzzle list --- */
.puzzle-list {
  margin: 8px 0 16px 20px;
  font-size: 0.95em;
  color: #a09080;
}

.puzzle-list li {
  margin-bottom: 4px;
}

/* --- Notice --- */
.notice {
  margin-top: 32px;
  padding: 16px 20px;
  background: #0e0808;
  border-left: 3px solid #3a2018;
  font-size: 0.88em;
  color: #806050;
  font-style: italic;
  line-height: 1.6;
}

/* --- Footer --- */
footer {
  padding: 20px 24px;
  border-top: 1px solid #201810;
  font-size: 0.85em;
  color: #504030;
  text-align: center;
}

footer a {
  color: #806050;
  border-bottom-color: #302018;
}

/* --- Responsive --- */
@media (max-width: 700px) {
  .sidebar { display: none; }
  .btn-row { flex-direction: column; }
  .btn { width: 100%; }
}
</style>
</head>
<body>

<!-- ===== LANDING VIEW ===== -->
<div class="landing" id="landing">
  <h1>Dracula's Castle</h1>
  <p class="subtitle">A Text Adventure &mdash; BASIC &amp; Inform 7</p>

  <div class="credits-box">
    <h3>Original Game</h3>
    <p>
      <em>Dracula's Castle</em> is a classic BASIC text adventure from the early 1980s,
      part of a wave of type-in vampire castle games that flourished on home computers
      of the era &mdash; alongside titles like
      <a href="https://bluerenga.blog/2019/12/08/vampire-castle-1980/">Vampire Castle</a> (1980) by Mike Bassman,
      <a href="https://en.wikipedia.org/wiki/The_Count_(video_game)">The Count</a> (1979) by Scott Adams,
      and <a href="https://bluerenga.blog/2025/08/23/castle-dracula-1983/">Castle Dracula</a> (1983) by Paul T. Johnson.
      These games defined a genre: explore a gothic castle, gather items, solve puzzles,
      and destroy the vampire before time runs out. The original BASIC source for this
      version was written for home microcomputers with ANSI terminal support and
      represents the ingenuity of an era when entire adventure games fit in a few
      kilobytes of code.
    </p>

    <h3>Inform 7 Translation</h3>
    <p>
      This project includes a faithful translation into
      <a href="https://ganelson.github.io/inform-website/">Inform 7</a>,
      the groundbreaking natural-language interactive fiction system created by
      <a href="https://en.wikipedia.org/wiki/Graham_Nelson">Graham Nelson</a>.
      Inform 7 allows authors to write interactive fiction in something close to
      English prose &mdash; a radical departure from traditional programming that
      opened the art form to writers of all backgrounds. Graham Nelson also created
      the original <a href="https://www.inform-fiction.org/">Inform</a> compiler (1993)
      and authored <em>Curses</em>, one of the landmark works of the post-Infocom era.
    </p>
    <p>
      <a href="https://en.wikipedia.org/wiki/Emily_Short">Emily Short</a> contributed
      enormously to Inform 7, writing most of the 300+ programming examples in the
      documentation and creating demo games that showed what the system could do.
      Her own works &mdash; <em>Galatea</em>, <em>Counterfeit Monkey</em>,
      <em>Bronze</em>, and many others &mdash; are landmarks of interactive fiction.
      <a href="https://github.com/ganelson/inform">Andrew Hunter</a> built the
      Inform 7 IDE for macOS, and countless contributors have extended the system
      with extensions, tools, and interpreters.
    </p>
  </div>

  <p>
    The castle contains 19 rooms, 25 objects, and over a dozen interlocking
    puzzles &mdash; from extinguishing fires and smashing through brickwork to
    rowing across underground lakes and staking vampires. A real-time clock
    ticks from 8:00 PM; if you haven't killed Dracula by midnight, he wakes
    and finds you.
  </p>

  <div class="btn-row">
    <button class="btn" onclick="showTab('basic')">View BASIC Source</button>
    <button class="btn" onclick="showTab('inform')">View Inform 7 Source</button>
    <a class="btn btn-play" href="play.html">Play the Game</a>
  </div>

  <h2>Key Puzzles</h2>
  <ol class="puzzle-list">
    <li>Read the sign to discover the goal &mdash; kill Dracula before midnight</li>
    <li>Push the bookcase in the Library to reveal a hidden passage</li>
    <li>Drop the flask of oil on the fire to enter the fireplace</li>
    <li>Smash the brick fireplace with the sledge hammer</li>
    <li>Tie rope to the parapets and climb down the tower</li>
    <li>Row the boat across the underground lake</li>
    <li>Use the crate to climb to the overhang, pry out nails, pull the tapestry</li>
    <li>Chop the crate into wooden stakes with the axe</li>
    <li>Oil the rusty door to reach Dracula's tomb</li>
    <li>Lure the rat with cheese to get the key</li>
    <li>Open the coffin and stake Dracula</li>
  </ol>

  <h2>About the Translation</h2>
  <p>
    The Inform 7 translation preserves the original game's map, puzzles, objects,
    and time system while taking advantage of Inform 7's natural-language syntax
    and built-in world model. The original BASIC source uses a compact data-driven
    engine with encoded verb/noun lookup tables; the Inform 7 version expresses
    the same logic through named rules, actions, and properties.
  </p>

  <h2>Acknowledgments</h2>

  <div class="credits-box">
    <h3>Inform &amp; Authoring</h3>
    <div class="links-grid">
      <a href="https://ganelson.github.io/inform-website/">Inform 7</a>
      <a href="https://en.wikipedia.org/wiki/Graham_Nelson">Graham Nelson &mdash; creator of Inform</a>
      <a href="https://en.wikipedia.org/wiki/Emily_Short">Emily Short &mdash; documentation, examples &amp; games</a>
      <a href="https://github.com/ganelson/inform">Inform Compiler (GitHub)</a>
      <a href="https://www.inform-fiction.org/">Inform 6 &amp; The Inform Fiction Library</a>
      <a href="https://i7-dungeon.sourceforge.net/index.html">Dean Menezes' Inform 7 Dungeon Port</a>
    </div>

    <h3>Interactive Fiction Community</h3>
    <div class="links-grid">
      <a href="https://intfiction.org/">IntFiction Forum</a>
      <a href="https://ifdb.org/">IFDB &mdash; Interactive Fiction Database</a>
      <a href="https://ifarchive.org/">IF Archive</a>
      <a href="https://ifcomp.org/">IFComp &mdash; Annual IF Competition</a>
      <a href="https://www.ifwiki.org/">IFWiki</a>
      <a href="https://itch.io/games/tag-interactive-fiction">Interactive Fiction on itch.io</a>
    </div>

    <h3>Interpreters &amp; Technology</h3>
    <div class="links-grid">
      <a href="https://github.com/curiousdannii/parchment">Parchment &mdash; Web IF Interpreter</a>
      <a href="https://eblong.com/zarf/glulx/quixe/">Quixe &mdash; Web Glulx Interpreter</a>
      <a href="https://eblong.com/zarf/glk/glkote/">GlkOte &mdash; Web Glk Library</a>
      <a href="https://github.com/erkyrath/glulxe">Glulxe &mdash; Reference Glulx Interpreter</a>
      <a href="https://www.eblong.com/zarf/glulx/">Glulx VM Specification</a>
      <a href="https://www.inform-fiction.org/zmachine/standards/z1point1/">Z-Machine Standard</a>
    </div>

    <h3>Classic Vampire Text Adventures</h3>
    <div class="links-grid">
      <a href="https://en.wikipedia.org/wiki/The_Count_(video_game)">The Count (1979) &mdash; Scott Adams</a>
      <a href="https://bluerenga.blog/2019/12/08/vampire-castle-1980/">Vampire Castle (1980) &mdash; Mike Bassman</a>
      <a href="https://bluerenga.blog/2025/08/23/castle-dracula-1983/">Castle Dracula (1983) &mdash; Paul T. Johnson</a>
      <a href="https://www.vintageisthenewold.com/draculas-castle-new-game-for-the-commodore-64">Dracula's Castle &mdash; C64 Port by MP Software</a>
    </div>
  </div>

  <p class="notice">
    The original BASIC source is believed to be an uncredited type-in program
    from the 1980s. No author attribution has been found in the code or in any
    historical archive. If you are the original author, please get in touch.
  </p>
</div>

<!-- ===== BASIC SOURCE VIEW ===== -->
<div class="tab-content" id="tab-basic">
  <div class="tab-bar">
    <button class="tab-btn" onclick="showTab('landing')">Home</button>
    <button class="tab-btn active" data-tab="basic">BASIC Source</button>
    <button class="tab-btn" onclick="showTab('inform')">Inform 7 Source</button>
    <a class="tab-btn" href="play.html" style="text-decoration:none;">Play</a>
  </div>
  <div class="source-view">
    <div class="source-toolbar">
      <span class="file-path" id="filepath-basic">src/basic/dracula.bas</span>
      <button class="toggle-btn" id="toggle-annotations" onclick="toggleAnnotations()">Annotated Code</button>
      <input type="text" class="search-box" id="search-basic" placeholder="Search... (Ctrl+F)">
      <span class="line-count" id="lc-basic"></span>
    </div>
    <div class="code-wrap" id="code-basic">
      <div class="loading"><em>Loading BASIC source...</em></div>
    </div>
  </div>
</div>

<!-- ===== INFORM 7 SOURCE VIEW ===== -->
<div class="tab-content" id="tab-inform">
  <div class="tab-bar">
    <button class="tab-btn" onclick="showTab('landing')">Home</button>
    <button class="tab-btn" onclick="showTab('basic')">BASIC Source</button>
    <button class="tab-btn active" data-tab="inform">Inform 7 Source</button>
    <a class="tab-btn" href="play.html" style="text-decoration:none;">Play</a>
  </div>
  <div class="source-with-nav">
    <div class="sidebar">
      <div class="nav" id="nav-inform"></div>
    </div>
    <div class="source-main">
      <div class="source-toolbar">
        <span class="file-path">src/inform/story.ni</span>
        <input type="text" class="search-box" id="search-inform" placeholder="Search... (Ctrl+F)">
        <span class="line-count" id="lc-inform"></span>
      </div>
      <div class="code-wrap" id="code-inform">
        <div class="loading"><em>Loading Inform 7 source...</em></div>
      </div>
    </div>
  </div>
</div>


<footer>
  <p>
    <em>Dracula's Castle</em> &mdash; a classic 1980s BASIC text adventure,
    translated to <a href="https://ganelson.github.io/inform-website/">Inform 7</a>.
    Playable via <a href="https://github.com/curiousdannii/parchment">Parchment</a>.
  </p>
  <p>
    Inform 7 translation and this site made with
    <a href="https://claude.ai/claude-code">Claude</a> by
    <a href="https://www.anthropic.com/">Anthropic</a>.
  </p>
</footer>

<script>
/* ==================================================================
   TAB NAVIGATION
   ================================================================== */
let currentTab = 'landing';
const loaded = { basic: false, inform: false };

function showTab(tab) {
  // Hide landing and all tabs
  document.getElementById('landing').style.display = (tab === 'landing') ? '' : 'none';
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelector('footer').style.display = (tab === 'landing') ? '' : 'none';

  if (tab !== 'landing') {
    const el = document.getElementById('tab-' + tab);
    if (el) el.classList.add('active');
    document.body.style.overflow = 'hidden';
  } else {
    document.body.style.overflow = '';
  }

  currentTab = tab;

  // Lazy-load source
  if (tab === 'basic' && !loaded.basic) loadBasic();
  if (tab === 'inform' && !loaded.inform) loadInform();
}

/* ==================================================================
   UTILITY
   ================================================================== */
function esc(s) {
  return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

/* ==================================================================
   BASIC SYNTAX HIGHLIGHTER
   ================================================================== */
const BAS_KW = /\b(PRINT|INPUT|IF|THEN|ELSE|GOTO|GOSUB|RETURN|FOR|TO|NEXT|STEP|READ|DATA|DIM|LET|ON|RUN|END|STOP|DEF|FN|RESTORE|RANDOMIZE|SWAP|WHILE|WEND|AND|OR|NOT|MOD)\b/g;
const BAS_FN = /\b(CHR\$|LEFT\$|RIGHT\$|MID\$|LEN|ASC|VAL|STR\$|TAB|INSTR|STRING\$|SPACE\$|INT|ABS|SGN|SQR|RND|USING)\b/g;

function highlightBasic(line) {
  // Match REM comments (whole rest of line)
  const remIdx = line.search(/\bREM\b/);
  if (remIdx !== -1 && (remIdx === 0 || /^\d+\s+REM/.test(line) || line[remIdx - 1] === ':' || line[remIdx - 1] === ' ')) {
    // Check that REM is not inside a string
    let inStr = false;
    for (let i = 0; i < remIdx; i++) {
      if (line[i] === '"') inStr = !inStr;
    }
    if (!inStr) {
      const before = line.slice(0, remIdx);
      const comment = line.slice(remIdx);
      return highlightBasicExpr(before) + '<span class="bas-rem">' + esc(comment) + '</span>';
    }
  }

  return highlightBasicExpr(line);
}

function highlightBasicExpr(line) {
  // Split into string literals and code segments
  let result = '';
  let inStr = false;
  let buf = '';

  for (let i = 0; i < line.length; i++) {
    const ch = line[i];
    if (ch === '"') {
      if (inStr) {
        buf += ch;
        result += '<span class="bas-str">' + esc(buf) + '</span>';
        buf = '';
        inStr = false;
      } else {
        result += highlightBasicCode(buf);
        buf = ch;
        inStr = true;
      }
    } else {
      buf += ch;
    }
  }

  if (inStr) {
    result += '<span class="bas-str">' + esc(buf) + '</span>';
  } else {
    result += highlightBasicCode(buf);
  }

  return result;
}

function highlightBasicCode(code) {
  if (!code) return '';
  let html = esc(code);

  // Line numbers at start of line
  html = html.replace(/^(\d+)(\s)/, '<span class="bas-ln">$1</span>$2');

  // Keywords
  html = html.replace(BAS_KW, '<span class="bas-kw">$1</span>');

  // Functions
  html = html.replace(BAS_FN, '<span class="bas-func">$1</span>');

  // Numbers (but not inside identifiers)
  html = html.replace(/(?<![A-Za-z$_])(\d+)(?![A-Za-z$_])/g, '<span class="bas-num">$1</span>');

  return html;
}

/* ==================================================================
   INFORM 7 SYNTAX HIGHLIGHTER
   ================================================================== */
const I7_HEADING = /^(Volume|Book|Part|Chapter|Section)\s+(.+)/;

function highlightInform(line) {
  if (I7_HEADING.test(line)) return '<span class="syn-head">' + esc(line) + '</span>';
  if (/^Table\s+/.test(line)) return '<span class="syn-tbl">' + esc(line) + '</span>';

  let out = '', state = 'normal', depth = 0, buf = '';

  function flush(cls) {
    if (!buf) return;
    if (cls) out += '<span class="' + cls + '">' + esc(buf) + '</span>';
    else out += esc(buf);
    buf = '';
  }

  for (let i = 0; i < line.length; i++) {
    const ch = line[i];
    if (state === 'normal') {
      if (ch === '"') { flush(); buf = ch; state = 'string'; }
      else if (ch === '[') { flush(); buf = ch; depth = 1; state = 'comment'; }
      else buf += ch;
    } else if (state === 'string') {
      buf += ch;
      if (ch === '[') {
        const before = buf.slice(0, -1);
        if (before) out += '<span class="syn-str">' + esc(before) + '</span>';
        buf = ch; state = 'sub'; depth = 1;
      } else if (ch === '"') { flush('syn-str'); state = 'normal'; }
    } else if (state === 'sub') {
      buf += ch;
      if (ch === '[') depth++;
      else if (ch === ']') { depth--; if (!depth) { flush('syn-sub'); state = 'string'; } }
    } else if (state === 'comment') {
      buf += ch;
      if (ch === '[') depth++;
      else if (ch === ']') { depth--; if (!depth) { flush('syn-cmt'); state = 'normal'; } }
    }
  }

  if (state === 'string') flush('syn-str');
  else if (state === 'comment') flush('syn-cmt');
  else if (state === 'sub') flush('syn-sub');
  else {
    if (buf) out += highlightI7Keywords(esc(buf));
    buf = '';
  }

  if (state === 'normal' && !out.includes('<span')) return highlightI7Keywords(esc(line));
  return out;
}

function highlightI7Keywords(html) {
  html = html.replace(/\b(Understand|understand|Instead of|Instead|instead of|instead|After|after|Before|before|Check|check|Carry out|carry out|Report|report|Every turn|every turn|When play begins|When|when|Rule|rule|This is|Definition|definition|To say|To decide|To |say |now |let |repeat|if |otherwise|else|end if|end while|end repeat|unless|does the player mean|Persuasion|persuasion|A thing|A room|A person|The )\b/g, '<span class="syn-kw">$1</span>');
  html = html.replace(/\b(\d+)\b/g, '<span class="syn-num">$1</span>');
  return html;
}

/* ==================================================================
   LOAD BASIC SOURCE (with annotation toggle)
   ================================================================== */
let basicAnnotated = false;       // current mode
let basicOriginalHtml = '';       // cached rendered HTML for original
let basicAnnotatedHtml = '';      // cached rendered HTML for annotated
let basicOriginalCount = 0;
let basicAnnotatedCount = 0;

function renderAnnotationText(raw) {
  // Strip the @@ prefix and leading space
  let text = raw.replace(/^@@\s?/, '');
  // Detect separator lines (=== or ---)
  if (/^[-=]{3,}/.test(text.trim()) || text.trim() === '') return { text: text, isRule: /^[-=]{3,}/.test(text.trim()) };
  return { text: text, isRule: false };
}

async function loadBasic() {
  const wrap = document.getElementById('code-basic');
  const lcEl = document.getElementById('lc-basic');

  try {
    // Load annotated file (superset â€” contains original lines and @@ annotations)
    const res = await fetch('../src/basic/dracula-annotated.bas');
    if (!res.ok) throw new Error(res.status);
    const source = await res.text();
    const allLines = source.split('\n');

    // Build annotated view (all lines, no line number column)
    const annoRows = allLines.map((raw, i) => {
      const isAnnotation = /^@@/.test(raw);
      if (isAnnotation) {
        const { text, isRule } = renderAnnotationText(raw);
        const cls = 'bas-annotation' + (isRule ? ' anno-rule' : '');
        return '<tr class="' + cls + '"><td class="lc">' + esc(text) + '</td></tr>';
      }
      return '<tr><td class="lc">' + highlightBasic(raw) + '</td></tr>';
    });
    basicAnnotatedHtml = '<table class="code">' + annoRows.join('') + '</table>';
    basicAnnotatedCount = allLines.filter(l => !/^@@/.test(l)).length;

    // Build original view (filter out @@ lines, no line number column)
    const origLines = allLines.filter(line => !/^@@/.test(line));
    const origRows = origLines.map((raw) => {
      return '<tr><td class="lc">' + highlightBasic(raw) + '</td></tr>';
    });
    basicOriginalHtml = '<table class="code">' + origRows.join('') + '</table>';
    basicOriginalCount = origLines.length;

    // Show original by default
    wrap.innerHTML = basicOriginalHtml;
    lcEl.textContent = basicOriginalCount + ' lines';
    loaded.basic = true;
    initSearch('basic', 'search-basic', 'code-basic');
  } catch (e) {
    wrap.innerHTML = '<div class="error-msg">Failed to load BASIC source. Make sure you are serving this page from a web server (not file://).</div>';
  }
}

function toggleAnnotations() {
  if (!loaded.basic) return;
  basicAnnotated = !basicAnnotated;

  const wrap = document.getElementById('code-basic');
  const lcEl = document.getElementById('lc-basic');
  const btn = document.getElementById('toggle-annotations');
  const fp = document.getElementById('filepath-basic');

  if (basicAnnotated) {
    wrap.innerHTML = basicAnnotatedHtml;
    lcEl.textContent = basicAnnotatedCount + ' lines of code';
    btn.textContent = 'Original Code';
    btn.classList.add('active');
    fp.textContent = 'src/basic/dracula-annotated.bas';
  } else {
    wrap.innerHTML = basicOriginalHtml;
    lcEl.textContent = basicOriginalCount + ' lines';
    btn.textContent = 'Annotated Code';
    btn.classList.remove('active');
    fp.textContent = 'src/basic/dracula.bas';
  }

  // Re-init search for new content
  initSearch('basic', 'search-basic', 'code-basic');
}

/* ==================================================================
   LOAD INFORM 7 SOURCE
   ================================================================== */
async function loadInform() {
  const wrap = document.getElementById('code-inform');
  const nav = document.getElementById('nav-inform');
  const lcEl = document.getElementById('lc-inform');

  try {
    const res = await fetch('../src/inform/story.ni');
    if (!res.ok) throw new Error(res.status);
    const source = await res.text();
    const lines = source.split('\n');
    lcEl.textContent = lines.length + ' lines';

    const navItems = [];
    const rows = lines.map((raw, i) => {
      const num = i + 1;
      const hm = raw.match(I7_HEADING);
      let cls = '';
      if (hm) {
        cls = ' class="heading-line"';
        const lvl = hm[1].toLowerCase();
        let nc = 'nav-item';
        if (lvl === 'volume' || lvl === 'book' || lvl === 'part') nc += ' nav-part';
        else if (lvl === 'chapter') nc += ' nav-chapter';
        else nc += ' nav-section';
        navItems.push('<a class="' + nc + '" data-line="' + num + '" href="#I' + num + '">' + esc(raw) + '</a>');
      }
      return '<tr id="I' + num + '"' + cls + '><td class="ln">' + num + '</td><td class="lc">' + highlightInform(raw) + '</td></tr>';
    });

    wrap.innerHTML = '<table class="code">' + rows.join('') + '</table>';
    nav.innerHTML = navItems.join('');
    loaded.inform = true;

    // Nav click
    nav.addEventListener('click', function(e) {
      const a = e.target.closest('.nav-item');
      if (!a) return;
      nav.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      a.classList.add('active');
      const row = document.getElementById('I' + a.dataset.line);
      if (row) row.scrollIntoView({ block: 'start' });
    });

    initSearch('inform', 'search-inform', 'code-inform');
  } catch (e) {
    wrap.innerHTML = '<div class="error-msg">Failed to load Inform 7 source. Make sure you are serving this page from a web server (not file://).</div>';
  }
}

/* ==================================================================
   SEARCH (shared for both source views)
   ================================================================== */
function initSearch(id, inputId, wrapId) {
  const input = document.getElementById(inputId);
  const wrap = document.getElementById(wrapId);
  let hits = [], cur = -1, debounce;

  function clear() {
    wrap.querySelectorAll('.search-hit').forEach(el => { el.outerHTML = el.textContent; });
    hits = []; cur = -1;
  }

  function doSearch(q) {
    clear();
    if (!q || q.length < 2) return;
    const lower = q.toLowerCase();
    wrap.querySelectorAll('td.lc').forEach(td => {
      if (td.textContent.toLowerCase().includes(lower)) markMatches(td, q);
    });
    hits = Array.from(wrap.querySelectorAll('.search-hit'));
    if (hits.length) { cur = 0; hits[0].classList.add('search-current'); hits[0].scrollIntoView({ block: 'center' }); }
  }

  function markMatches(el, q) {
    const walker = document.createTreeWalker(el, NodeFilter.SHOW_TEXT);
    const nodes = []; while (walker.nextNode()) nodes.push(walker.currentNode);
    const lower = q.toLowerCase();
    nodes.forEach(node => {
      const text = node.textContent, idx = text.toLowerCase().indexOf(lower);
      if (idx === -1) return;
      const span = document.createElement('span');
      span.className = 'search-hit';
      span.textContent = text.slice(idx, idx + q.length);
      const parent = node.parentNode;
      if (idx > 0) parent.insertBefore(document.createTextNode(text.slice(0, idx)), node);
      parent.insertBefore(span, node);
      const after = text.slice(idx + q.length);
      if (after) { const tn = document.createTextNode(after); parent.insertBefore(tn, node); }
      parent.removeChild(node);
    });
  }

  function next() { if (!hits.length) return; hits[cur].classList.remove('search-current'); cur = (cur + 1) % hits.length; hits[cur].classList.add('search-current'); hits[cur].scrollIntoView({ block: 'center' }); }
  function prev() { if (!hits.length) return; hits[cur].classList.remove('search-current'); cur = (cur - 1 + hits.length) % hits.length; hits[cur].classList.add('search-current'); hits[cur].scrollIntoView({ block: 'center' }); }

  input.addEventListener('input', function() { clearTimeout(debounce); debounce = setTimeout(() => doSearch(this.value), 200); });
  input.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') { e.preventDefault(); e.shiftKey ? prev() : next(); }
    if (e.key === 'Escape') { clear(); this.value = ''; this.blur(); }
  });
}


/* ==================================================================
   KEYBOARD SHORTCUTS
   ================================================================== */
document.addEventListener('keydown', function(e) {
  if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
    if (currentTab === 'basic' || currentTab === 'inform') {
      e.preventDefault();
      document.getElementById('search-' + currentTab).focus();
      document.getElementById('search-' + currentTab).select();
    }
  }
  if (e.key === 'Escape' && currentTab !== 'landing') {
    showTab('landing');
  }
});
</script>

</body>
</html>
